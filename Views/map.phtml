<?php require('template/header.phtml') ?>

<h3>Welcome to the Map Page</h3>
<p>
    This map allows you to track the location of mutually accepted friends in real time.
</p>

<p id="output"></p>

<div id="Map" style="width:800px;height:600px" onmouseenter="loadFriends()"></div>
<script src="/OpenLayers-2.13.1/OpenLayers.js"></script>
<script>
    var friends = [];
    function loadFriends(){
        var xmlhttp = new XMLHttpRequest();

        xmlhttp.onreadystatechange = function () {
            if(this.readyState == 4 && this.status == 200) {
                if(this.response.length !== 0)
                {
                    //console.log(this.response);
                    friends = JSON.parse(this.responseText);
                    console.log(friends);
                    markers.clearMarkers();
                    friends.forEach(createMarker);
                }
            }
        }
        xmlhttp.open("GET", "friendsajax.php", false);
        xmlhttp.send();
    }

    map = new OpenLayers.Map("Map");
    mapnik = new OpenLayers.Layer.OSM();
    map.addLayer(mapnik);

    var lonLat = new OpenLayers.LonLat( 0, 40).transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject());

    var zoom=3;

    var markers = new OpenLayers.Layer.Markers( "Markers" );
    map.addLayer(markers);

    friends.forEach(function(friend)
    {
        console.log(friend.username);
    })

    function createMarker(friend)
    {
        //Test
        console.log(friend.username);
        //Creating Marker
        let mposition = new OpenLayers.LonLat( friend.longitude , friend.latitude ).transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject());
        markers.addMarker(new OpenLayers.Marker(mposition));
    }

    map.setCenter (lonLat, zoom);

    loadFriends();
</script>

</div>
<?php require('template/footer.phtml') ?>
